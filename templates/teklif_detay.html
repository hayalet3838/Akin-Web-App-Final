<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teklif Formu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6; --text-dark: #1e293b; --text-light: #64748b;
            --border-color: #e2e8f0; --page-bg: #f1f5f9; --card-bg: #ffffff;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--page-bg); margin: 0; padding: 2rem; color: #333;
        }
        .page-container {
            position: relative; max-width: 850px; margin: 0 auto; background: var(--card-bg);
            padding: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border-radius: 8px;
            overflow: hidden;
        }
        .watermark {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            opacity: 0.04; z-index: 1; pointer-events: none;
            width: 500px; height: 500px;
            background-repeat: no-repeat; background-position: center; background-size: contain;
        }
        .proposal-content { position: relative; z-index: 2; }
        .header {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 40px; margin: -50px -50px 0 -50px;
            background-color: var(--primary-color); color: white;
        }
        .header .company-logo img {
            max-width: 200px; max-height: 80px; object-fit: contain;
            filter: brightness(0) invert(1);
        }
        .header .document-info { text-align: right; }
        .document-info h1 { font-size: 28pt; margin: 0; color: white; font-weight: 700; }
        .document-info p { margin: 5px 0 0 0; color: rgba(255, 255, 255, 0.8); font-size: 11pt; }
        .content-area { padding-top: 40px; }
        .parties-info {
            display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;
        }
        .info-box h2 {
            font-size: 10pt; font-weight: 700; color: var(--primary-color);
            text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px; margin: 0 0 12px 0;
        }
        .info-box p { margin: 5px 0; font-size: 11pt; line-height: 1.6; }
        .info-box strong { font-weight: 500; color: var(--text-dark); }
        .items-table { width: 100%; border-collapse: collapse; font-size: 11pt; }
        .items-table thead th {
            text-align: left; padding: 12px;
            background-color: var(--primary-color); color: white;
            font-weight: 500;
        }
        .items-table tbody td { padding: 15px 12px; border-bottom: 1px solid var(--border-color); }
        .items-table .text-right { text-align: right; }
        .summary-section { display: flex; justify-content: space-between; margin-top: 30px; align-items: flex-end; }
        .qr-code { text-align: center; }
        #qrcode { display: inline-block; padding: 5px; background: white; border: 1px solid var(--border-color); }
        .summary-table { width: 45%; }
        .summary-table td { padding: 8px 0; }
        .summary-table .label { color: var(--text-light); font-weight: 500; }
        .summary-table .grand-total .label, .summary-table .grand-total .value {
            font-size: 16pt; font-weight: 700; color: var(--primary-color);
            padding-top: 10px; border-top: 2px solid var(--primary-color);
        }
        .footer { margin-top: 50px; text-align: center; font-size: 9pt; color: #999; }
        .page-actions { text-align: center; margin-bottom: 2rem; display: flex; justify-content: center; gap: 1rem; }
        .btn-action { padding: 12px 25px; color: white; border: none; cursor: pointer; font-size: 1rem; font-weight: 500; border-radius: 5px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-print { background: var(--primary-color); }
        .btn-image { background: #16a34a; }
        .btn-back { background: #64748b; }

        @media print {
            @page { size: A4; margin: 0; }
            body { background-color: white; padding: 0; -webkit-print-color-adjust: exact; }
            .page-container { box-shadow: none; border-radius: 0; max-width: 100%; padding: 25mm; }
            .page-actions { display: none; }
        }
    </style>
</head>
<body>
    <div class="page-actions">
        <a href="/teklifler" class="btn-action btn-back"><i class="fas fa-arrow-left"></i> Listeye Dön</a>
        <button class="btn-action btn-print" onclick="window.print()"><i class="fas fa-print"></i> Yazdır</button>
        <button class="btn-action btn-image" id="downloadBtn"><i class="fas fa-camera"></i> Resim Olarak İndir</button>
    </div>
    <div class="page-container">
        <div class="watermark" id="watermark"></div>
        <div class="proposal-content">
            <header class="header">
                <div class="company-logo"><img id="sirket_logo" src="" alt="Firma Logosu"></div>
                <div class="document-info">
                    <h1>TEKLİF</h1>
                    <p>Teklif No: <strong id="teklif_kodu"></strong></p>
                    <p>Tarih: <span id="teklif_tarihi"></span></p>
                    <p>Geçerlilik: <span id="gecerlilik_tarihi"></span></p>
                </div>
            </header>
            <div class="content-area">
                <section class="parties-info">
                    <div class="info-box">
                        <h2><i class="fas fa-building"></i> TEKLİF VEREN</h2>
                        <p><strong id="sirket_adi"></strong></p>
                        <p id="sirket_adresi"></p>
                        <p><i class="fas fa-user-tie" style="margin-right: 5px;"></i><span id="sirket_yetkili_kisi"></span></p>
                    </div>
                    <div class="info-box">
                        <h2><i class="fas fa-user"></i> TEKLİF ALAN</h2>
                        <p><strong id="musteri_adi"></strong></p>
                        <p id="musteri_adresi"></p>
                        <p id="musteri_telefon"></p>
                    </div>
                </section>
                <main>
                    <table class="items-table">
                        <thead><tr><th>AÇIKLAMA</th><th class="text-right">MİKTAR</th><th class="text-right">BİRİM FİYAT</th><th class="text-right">TOPLAM</th></tr></thead>
                        <tbody id="kalemler"></tbody>
                    </table>
                    <section class="summary-section">
                        <div class="qr-code">
                            <div id="qrcode"></div>
                            <p style="font-size: 8pt; color: var(--text-light); margin-top: 5px;">Hızlı Erişim</p>
                        </div>
                        <table class="summary-table">
                            <tr><td class="label">Ara Toplam</td><td class="text-right value" id="ara_toplam"></td></tr>
                            <tr><td class="label">Toplam KDV</td><td class="text-right value" id="kdv_toplami"></td></tr>
                            <tr class="grand-total"><td class="label">GENEL TOPLAM</td><td class="text-right value" id="genel_toplam"></td></tr>
                        </table>
                    </section>
                </main>
                <footer class="footer">
                    <p id="sirket_iletisim"></p>
                </footer>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const teklifId = window.location.pathname.split('/').pop();
        if (!teklifId || isNaN(teklifId)) { document.body.innerHTML = '<h1>Geçersiz Teklif ID</h1>'; return; }
        try {
            const response = await fetch(`/api/teklifler/${teklifId}`);
            const data = await response.json();
            if (!response.ok) throw new Error(data.detail);
            const { teklif, kalemler, sirket } = data;
            const formatCurrency = (val) => (val != null ? parseFloat(val) : 0).toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
            
            document.getElementById('sirket_logo').src = sirket.firma_logo_yolu || '';
            document.getElementById('watermark').style.backgroundImage = `url(${sirket.firma_logo_yolu || ''})`;
            document.getElementById('sirket_adi').textContent = sirket.firma_adi || '';
            document.getElementById('sirket_adresi').textContent = sirket.firma_adresi || '';
            document.getElementById('sirket_yetkili_kisi').textContent = sirket.firma_yetkili_kisi || '';
            document.getElementById('sirket_iletisim').textContent = `${sirket.firma_telefon || ''} | ${sirket.firma_email || ''} | ${sirket.firma_website || ''}`;
            document.title = `Teklif #${teklif.teklif_kodu}`;
            document.getElementById('teklif_kodu').textContent = teklif.teklif_kodu;
            document.getElementById('teklif_tarihi').textContent = new Date(teklif.teklif_tarihi).toLocaleDateString('tr-TR');
            document.getElementById('gecerlilik_tarihi').textContent = new Date(teklif.gecerlilik_tarihi).toLocaleDateString('tr-TR');
            document.getElementById('musteri_adi').textContent = teklif.musteri_adi;
            document.getElementById('musteri_adresi').textContent = teklif.musteri_adres || '';
            document.getElementById('musteri_telefon').textContent = teklif.musteri_telefon || '';
            const kalemlerTbody = document.getElementById('kalemler');
            kalemlerTbody.innerHTML = '';
            kalemler.forEach(k => {
                kalemlerTbody.innerHTML += `
                    <tr>
                        <td style="width:55%;">${k.aciklama}</td>
                        <td class="text-right">${k.miktar} ${k.birim}</td>
                        <td class="text-right">${formatCurrency(k.birim_fiyat)}</td>
                        <td class="text-right">${formatCurrency(k.toplam_fiyat)}</td>
                    </tr>`;
            });
            document.getElementById('ara_toplam').textContent = formatCurrency(teklif.toplam_tutar);
            document.getElementById('kdv_toplami').textContent = formatCurrency(teklif.kdv_tutari);
            document.getElementById('genel_toplam').textContent = formatCurrency(teklif.genel_toplam);
            if (sirket.firma_website) {
                new QRCode(document.getElementById("qrcode"), { text: sirket.firma_website, width: 80, height: 80, });
            }
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.addEventListener('click', () => {
                downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Oluşturuluyor...';
                downloadBtn.disabled = true;
                html2canvas(document.querySelector('.page-container'), { scale: 3, useCORS: true })
                .then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Teklif-${teklif.teklif_kodu}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }).finally(() => {
                    downloadBtn.innerHTML = '<i class="fas fa-camera"></i> Resim Olarak İndir';
                    downloadBtn.disabled = false;
                });
            });
        } catch (error) { document.body.innerHTML = `<h1>Hata: ${error.message}</h1>`; }
    });
    </script>
</body>
</html>