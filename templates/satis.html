<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeni Satış Fişi - Düğmeci Makina</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --main-bg: #f1f5f9; --text-dark: #0f172a; --text-light: #64748b;
            --primary-color: #3b82f6; --border-color: #e2e8f0; --card-bg: #fff;
            --success-color: #22c55e; --danger-color: #ef4444; --print-color: #0d9488;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--main-bg); color: var(--text-dark); margin:0; }
        .top-nav { background-color: var(--card-bg); padding: 0 2rem; height: 70px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.5rem; font-weight: 600; text-decoration: none; color: var(--text-dark); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; text-decoration: none; padding: 0.7rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-dark); cursor: pointer; }
        .btn:hover { background-color: #f8fafc; transform: translateY(-2px); }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #64748b; color: white; border-color: #64748b; }
        .btn-secondary:hover { background-color: #475569; }
        .btn-success { background-color: var(--success-color); color: white; border-color: var(--success-color); }
        .btn-print { background-color: var(--print-color); color: white; border-color: var(--print-color); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
        .page-header { margin-bottom: 2rem; }
        .page-header h1 { font-size: 2.25rem; font-weight: 700; margin: 0; }
        .content-card { background-color: var(--card-bg); border-radius: 0.75rem; padding: 2rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: 1px solid var(--border-color); border-top: 4px solid var(--primary-color); margin-bottom: 2rem; }
        .content-card h2 { font-size: 1.5rem; color: var(--text-dark); border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-top: 0; margin-bottom: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-size: 1rem; }
        .form-group input[readonly] { background-color: #f8fafc; }
        .items-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        .items-table th, .items-table td { padding: 0.75rem; border-bottom: 1px solid var(--border-color); text-align: left; vertical-align: top; }
        .items-table thead { background-color: #f8fafc; }
        .items-table th { font-weight: 600; color: var(--text-light); font-size: 0.875rem; text-transform: uppercase; }
        .items-table input { width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-size: 0.95rem; }
        .items-table .col-product { width: 45%; } .items-table .col-actions { width: 5%; text-align: center; }
        .stock-info { font-size: 0.8rem; color: var(--text-light); margin-top: 0.25rem; }
        .stock-info.low-stock { color: var(--danger-color); font-weight: 600; }
        .actions-and-summary { display: flex; justify-content: space-between; align-items: flex-start; margin-top: 1.5rem; gap: 2rem; flex-wrap: wrap; }
        .summary-box { width: 320px; border: 1px solid var(--border-color); border-radius: 0.75rem; overflow: hidden; font-size: 1rem; flex-shrink: 0; margin-left: auto; }
        .summary-row { display: flex; justify-content: space-between; padding: 1rem 1.25rem; }
        .summary-row.grand-total { background-color: var(--text-dark); color: white; font-size: 1.2rem; font-weight: 600; }
        .page-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-bottom: 2rem; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 1rem; opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <nav class="top-nav">
        <a href="/" class="logo"><i class="fas fa-cash-register"></i> Yeni Satış Fişi</a>
        <a href="/" class="btn btn-secondary"><i class="fas fa-home"></i> Ana Sayfaya Dön</a>
    </nav>
    <form id="satisFisiForm">
        <div class="container">
            <div class="page-header">
                <h1>Yeni Satış Fişi Oluştur</h1>
            </div>

            <div class="content-card">
                <h2>Fiş Bilgileri</h2>
                <div class="form-grid">
                    <div class="form-group"><label for="musteri">Müşteri</label><select id="musteri" required></select></div>
                    <div class="form-group"><label for="fis_kodu">Fiş Numarası</label><input type="text" id="fis_kodu" readonly></div>
                    <div class="form-group"><label for="fis_tarihi">Fiş Tarihi</label><input type="date" id="fis_tarihi" required></div>
                </div>
            </div>

            <div class="content-card">
                <h2>Fiş Kalemleri</h2>
                <table class="items-table" id="fisKalemleri">
                    <thead><tr><th class="col-product">Ürün</th><th>Miktar</th><th>Birim Fiyat (₺)</th><th>KDV (%)</th><th>Toplam (₺)</th><th class="col-actions"></th></tr></thead>
                    <tbody></tbody>
                </table>
                <datalist id="urun-listesi-datalist"></datalist>
                <div class="actions-and-summary">
                    <button type="button" class="btn btn-success" id="addRowBtn"><i class="fas fa-plus"></i> Yeni Ürün Ekle</button>
                    <div class="summary-box">
                        <div class="summary-row"><span>Ara Toplam</span><strong id="araToplam">0.00 ₺</strong></div>
                        <div class="summary-row"><span>Toplam KDV</span><strong id="toplamKdv">0.00 ₺</strong></div>
                        <div class="summary-row grand-total"><span>Genel Toplam</span><strong id="genelToplam">0.00 ₺</strong></div>
                    </div>
                </div>
            </div>

            <div class="page-actions">
                <button type="button" id="saveAndPrintBtn" class="btn btn-print"><i class="fas fa-print"></i> Kaydet ve Yazdır</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Fişi Kaydet</button>
            </div>
        </div>
    </form>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const musteriSelect = document.getElementById('musteri');
        const kalemlerTbody = document.querySelector('#fisKalemleri tbody');
        const addRowBtn = document.getElementById('addRowBtn');
        const form = document.getElementById('satisFisiForm');
        const saveAndPrintBtn = document.getElementById('saveAndPrintBtn');
        const urunDatalist = document.getElementById('urun-listesi-datalist');
        let urunListesi = [];

        function generateFisKodu() {
            const now = new Date();
            const timestamp = now.getFullYear().toString().slice(-2) + 
                              (now.getMonth() + 1).toString().padStart(2, '0') + 
                              now.getDate().toString().padStart(2, '0') + '-' +
                              now.getHours().toString().padStart(2, '0') + 
                              now.getMinutes().toString().padStart(2, '0');
            document.getElementById('fis_kodu').value = `FIS-${timestamp}`;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        async function loadInitialData() {
            try {
                const [musteriRes, urunRes] = await Promise.all([ fetch('/api/musteriler'), fetch('/api/urunler') ]);
                const musteriler = await musteriRes.json();
                urunListesi = await urunRes.json();

                musteriSelect.innerHTML = '<option value="">Lütfen bir müşteri seçin...</option>';
                musteriler.forEach(m => musteriSelect.innerHTML += `<option value="${m.id}">${m.ad}</option>`);
                
                urunDatalist.innerHTML = '';
                urunListesi.forEach(u => urunDatalist.innerHTML += `<option value="${u.urun_adi}"></option>`);
                
                createNewRow();
            } catch (err) {
                showToast('Gerekli veriler yüklenemedi!', 'error');
            }
        }

        function createNewRow() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="col-product">
                    <input type="text" list="urun-listesi-datalist" class="form-control kalem-urun" placeholder="Ürün adını yazın..." required>
                    <div class="stock-info"></div>
                </td>
                <td><input type="number" class="form-control kalem-miktar" value="1" step="any" min="1"></td>
                <td><input type="number" class="form-control kalem-birim-fiyat" value="0.00" step="any" min="0"></td>
                <td><input type="number" class="form-control kalem-kdv" value="20" min="0"></td>
                <td><input type="text" class="form-control kalem-toplam" readonly style="background-color:#f8fafc; text-align:right;"></td>
                <td class="col-actions"><button type="button" class="btn" style="background-color:var(--danger-color); color:white; padding:0.5rem;" onclick="this.closest('tr').remove(); calculateTotals();"><i class="fas fa-trash"></i></button></td>
            `;
            kalemlerTbody.appendChild(tr);
            return tr;
        }

        function calculateTotals() {
            let araToplam = 0, toplamKdv = 0;
            document.querySelectorAll('#fisKalemleri tbody tr').forEach(tr => {
                const miktar = parseFloat(tr.querySelector('.kalem-miktar').value) || 0;
                const birimFiyat = parseFloat(tr.querySelector('.kalem-birim-fiyat').value) || 0;
                const kdvOrani = parseFloat(tr.querySelector('.kalem-kdv').value) || 0;
                const satirToplam = miktar * birimFiyat;
                const satirKdv = satirToplam * (kdvOrani / 100);
                tr.querySelector('.kalem-toplam').value = (satirToplam + satirKdv).toFixed(2);
                araToplam += satirToplam;
                toplamKdv += satirKdv;
            });
            const formatCurrency = (val) => val.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
            document.getElementById('araToplam').textContent = formatCurrency(araToplam);
            document.getElementById('toplamKdv').textContent = formatCurrency(toplamKdv);
            document.getElementById('genelToplam').textContent = formatCurrency(araToplam + toplamKdv);
        }
        
        kalemlerTbody.addEventListener('input', e => {
            const target = e.target;
            const row = target.closest('tr');

            if (target.matches('.kalem-urun')) {
                const foundProduct = urunListesi.find(u => u.urun_adi === target.value);
                const stockInfoDiv = row.querySelector('.stock-info');
                if (foundProduct) {
                    row.dataset.urunId = foundProduct.id;
                    row.dataset.stokFiyati = foundProduct.birim_fiyat || 0;
                    row.querySelector('.kalem-birim-fiyat').value = (foundProduct.birim_fiyat || 0).toFixed(2);
                    stockInfoDiv.textContent = `Stok: ${foundProduct.stok_miktari}`;
                    stockInfoDiv.className = 'stock-info';
                    if(foundProduct.stok_miktari <= 0) {
                        stockInfoDiv.classList.add('low-stock');
                    }
                } else {
                    row.dataset.urunId = '';
                    row.dataset.stokFiyati = '0';
                    stockInfoDiv.textContent = '';
                }
            }
            calculateTotals();
        });

        kalemlerTbody.addEventListener('change', e => {
            const target = e.target;
            if (target.matches('.kalem-birim-fiyat')) {
                const row = target.closest('tr');
                const stokFiyati = parseFloat(row.dataset.stokFiyati) || 0;
                const girilenFiyat = parseFloat(target.value) || 0;
                if (stokFiyati > 0 && girilenFiyat < stokFiyati) {
                    if (!confirm(`Dikkat! Girdiğiniz fiyat (${girilenFiyat.toFixed(2)} ₺), ürünün liste fiyatından (${stokFiyati.toFixed(2)} ₺) daha düşük. Devam etmek istiyor musunuz?`)) {
                        target.value = stokFiyati.toFixed(2);
                        calculateTotals();
                    }
                }
            }
        });

        async function saveSlip() {
            const siparisData = {
                musteri_id: parseInt(musteriSelect.value),
                siparis_kodu: document.getElementById('fis_kodu').value,
                toplam_tutar: parseFloat(document.getElementById('araToplam').textContent.replace(/[^\d,-]/g, '').replace(',', '.')),
                kdv_tutari: parseFloat(document.getElementById('toplamKdv').textContent.replace(/[^\d,-]/g, '').replace(',', '.')),
                genel_toplam: parseFloat(document.getElementById('genelToplam').textContent.replace(/[^\d,-]/g, '').replace(',', '.'))
            };
            const kalemlerData = Array.from(document.querySelectorAll('#fisKalemleri tbody tr')).map(tr => ({
                urun_id: parseInt(tr.dataset.urunId),
                miktar: parseFloat(tr.querySelector('.kalem-miktar').value) || 0,
                birim_fiyat: parseFloat(tr.querySelector('.kalem-birim-fiyat').value) || 0,
                kdv_orani: parseInt(tr.querySelector('.kalem-kdv').value) || 0,
                toplam_fiyat: parseFloat(tr.querySelector('.kalem-toplam').value) || 0
            }));
            if (!siparisData.musteri_id) { showToast('Lütfen bir müşteri seçin.', 'error'); return Promise.reject('Validation failed'); }
            if (kalemlerData.some(k => !k.urun_id)) { showToast('Lütfen tüm satırlarda geçerli bir ürün seçin.', 'error'); return Promise.reject('Validation failed'); }

            const response = await fetch('/api/satis-fisleri', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ siparis: siparisData, kalemler: kalemlerData })
            });
            if (!response.ok) { const err = await response.json(); throw new Error(err.detail); }
            return await response.json();
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
            saveSlip().then(data => {
                showToast(data.message, 'success');
                form.reset();
                kalemlerTbody.innerHTML = '';
                generateFisKodu();
                createNewRow();
                calculateTotals();
            }).catch(err => { if(err.message !== 'Validation failed') showToast('Hata: ' + err.message, 'error');
            }).finally(() => {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            });
        });

        saveAndPrintBtn.addEventListener('click', function() {
            const originalText = this.innerHTML;
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
            saveSlip().then(data => {
                showToast(data.message, 'success');
                window.open(`/fis-yazdir/${data.siparis_id}`, '_blank');
                form.reset();
                kalemlerTbody.innerHTML = '';
                generateFisKodu();
                createNewRow();
                calculateTotals();
            }).catch(err => { if(err.message !== 'Validation failed') showToast('Hata: ' + err.message, 'error');
            }).finally(() => {
                this.disabled = false;
                this.innerHTML = originalText;
            });
        });
        
        addRowBtn.addEventListener('click', createNewRow);

        document.getElementById('fis_tarihi').valueAsDate = new Date();
        generateFisKodu();
        loadInitialData();
        
        form.addEventListener('keydown', function(e) {
            if (e.key !== 'Enter') return;
            const activeElement = document.activeElement;
            if (!activeElement || (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'SELECT')) { return; }
            e.preventDefault();
            const currentRow = activeElement.closest('tr');
            if (currentRow) {
                const inputsInRow = Array.from(currentRow.querySelectorAll('input:not([readonly])'));
                const currentIndexInRow = inputsInRow.indexOf(activeElement);
                if (currentIndexInRow < inputsInRow.length - 1) {
                    inputsInRow[currentIndexInRow + 1].focus();
                } else {
                    const nextRow = currentRow.nextElementSibling;
                    if (nextRow) {
                        nextRow.querySelector('.kalem-urun').focus();
                    } else {
                        addRowBtn.click();
                        const newLastRow = kalemlerTbody.querySelector('tr:last-child');
                        if (newLastRow) {
                            newLastRow.querySelector('.kalem-urun').focus();
                        }
                    }
                }
            } else {
                const focusable = Array.from(form.querySelectorAll('select, input:not([readonly])'));
                const index = focusable.indexOf(activeElement);
                if (index > -1 && index < focusable.length - 1) {
                    focusable[index + 1].focus();
                } else {
                    const firstProductInput = kalemlerTbody.querySelector('.kalem-urun');
                    if (firstProductInput) {
                        firstProductInput.focus();
                    }
                }
            }
        });
    });
    </script>
</body>
</html>